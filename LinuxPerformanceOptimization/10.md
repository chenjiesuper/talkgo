## 工具
```
apt-get install docker.io sysstat hping3 tcpdump
```
* sar 是一个系统活动报告工具，既可以实时查看系统的当前活动，又可以配置保存和报告历史统计数据。
* hping3 是一个可以构造 TCP/IP 协议数据包的工具，可以对系统进行安全审计、防火墙测试等。
* tcpdump 是一个常用的网络抓包工具，常用来分析各种网络问题。

运行 hping3 命令，来模拟 Nginx 的客户端请求
```
# -S参数表示设置TCP协议的SYN（同步序列号），-p表示目的端口为80
# -i u100表示每隔100微秒发送一个网络帧
# 注：如果你在实践过程中现象不明显，可以尝试把100调小，比如调成10甚至1
$ hping3 -S -p 80 -i u100 127.0.0.1
```
## 排查流程
1. top 观察CPU 的使用率都用在了软中断上，从进程列表上也可以看到，CPU 使用率最高的也是软中断进程 ksoftirqd。看起来，软中断有点可疑了。
>[CentOS详解top命令各个数据的含义](https://www.cnblogs.com/ronli/p/centos-top.html)
>si 软中断（Software Interrupts）占用CPU的百分比
2. watch -d cat /proc/softirqs，NET_RX变化（排除其余几个是linux正常调度工作需要），从网络接收的软中断着手，继续分析
3. sar可以用来查看系统的网络收发情况，还有一个好处是，不仅可以观察网络收发的吞吐量（BPS，每秒收发的字节数），还可以观察网络收发的 PPS，即每秒收发的网络帧数。

```
# -n DEV 表示显示网络收发的报告，间隔1秒输出一组数据
$ sar -n DEV 1
15:03:46        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
15:03:47         eth0  12607.00   6304.00    664.86    358.11      0.00      0.00      0.00      0.01
15:03:47      docker0   6302.00  12604.00    270.79    664.66      0.00      0.00      0.00      0.00
15:03:47           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
15:03:47    veth9f6bbcd   6302.00  12604.00    356.95    664.66      0.00      0.00      0.00      0.05
```

重点来看 eth0 ：接收的 PPS 比较大，达到 12607，而接收的 BPS 却很小，只有 664 KB。直观来看网络帧应该都是比较小的，我们稍微计算一下，664*1024/12607 = 54 字节，说明平均每个网络帧只有 54 字节，这显然是很小的网络帧，也就是我们通常所说的小包问题。
4. tcpdump 抓取 eth0 上的包(获取网络帧从哪里发过来的)
```
# -i eth0 只抓取eth0网卡，-n不解析协议名和主机名
# tcp port 80表示只抓取tcp协议并且端口号为80的网络帧
$ tcpdump -i eth0 -n tcp port 80
15:11:32.678966 IP 192.168.0.2.18238 > 192.168.0.30.80: Flags [S], seq 458303614, win 512, length 0
...
```
>tcpdump -n, 可以清晰看到以太网以及ip地址而不是名字标识

从系统的软中断使用率高这个现象出发，通过观察 /proc/softirqs 文件的变化情况，判断出软中断类型是网络接收中断；再通过 sar 和 tcpdump ，确认这是一个 SYN FLOOD 问题。SYN FLOOD 问题最简单的解决方法，就是从交换机或者硬件防火墙中封掉来源 IP，这样 SYN FLOOD 网络帧就不会发送到服务器中。

## 小结
软中断 CPU 使用率（softirq）升高是一种很常见的性能问题。虽然软中断的类型很多，但实际生产中，我们遇到的性能瓶颈大多是网络收发类型的软中断，特别是网络接收的软中断。
在碰到这类问题时，可以借用 sar、tcpdump 等工具，做进一步分析。

## 发现精选留言
>统一回复一下终端卡顿的问题，这个是由于网络延迟增大（甚至是丢包）导致的。比如你可以再拿另外一台机器（也就是第三台）在 hping3 运行的前后 ping 一下案例机器，ping -c3 <ip>
>hping3 运行前，你可能看到最长的也不超过 1 ms：
>3 packets transmitted, 3 received, 0% packet loss, time 2028ms
>rtt min/avg/max/mdev = 0.815/0.914/0.989/0.081 ms
>而 hping3 运行时，不仅平均延迟增长到了 245 ms，而且还会有丢包的发生：
>3 packets transmitted, 2 received, 33% packet loss, time 2026ms
>rtt min/avg/max/mdev = 240.637/245.758/250.880/5.145 ms
>网络问题的排查方法在后面的文章中还会讲，这儿只是从 CPU 利用率的角度出发，你可以>发现也有可能是网络导致的问题。

思考：终端卡端是因为hping3大量发包导致导致其他网络连接延迟

>有个问题，网络收到的数据。平均每帧多少算是小包呢，文中是50字节，如果是200或者300字节算是小包吗
作者回复: 这个应该没有标准，我见到的大多涉及小包的讨论都是 100 以下的
