# 第 1 阶段笔记 （进行中）
## 02 | 基础篇：到底应该怎么理解“平均负载”？

### 平均负载定义：

平均负载最理想的情况是等于 CPU 个数。所以在评判平均负载时， 首先你要知道系统有几个 CPU ，这可以通过 top 命令或者从文件 /proc/cpuinfo 中读取

相关命令
```
grep 'model name' /proc/cpuinfo | wc -l
```

### 平均负载监控：

**当平均负载高于 CPU 数量 70% 的时候** ，你就应该分析排查负载高的问题了。一旦负载过高，就可能导致进程响应变慢，进而影响服务的正常功能。

但 70% 这个数字并不是绝对的，最推荐的方法，还是把系统的平均负载监控起来，然后根据更多的历史数据，判断负载的变化趋势。当发现负载有明显升高趋势时，比如说负载翻倍了，你再去做分析和调查。

### 平均负载高的场景：

平均负载是指单位时间内，处于可运行状态和不可中断状态的进程数。所以，它不仅包括了 **正在使用 CPU**  的进程，还包括 **等待 CPU**  和 **等待 I/O**  的进程。

而 CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应。比如：

* CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的；

* I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；

* 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高。

### 工具：

安装命令：apt install stress sysstat。

stress ：一个 Linux 系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场景。

sysstat ：包含了常用的 Linux 性能工具，用来监控和分析系统的性能。我们的案例会用到这个包的两个命令 mpstat 和 pidstat。

* mpstat 是一个常用的多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有 CPU 的平均指标。
* pidstat 是一个常用的进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及上下文切换等性能指标。
```
//模拟 I/O 压力，即不停地执行 sync：
stress -i 1 --timeout 600
//模拟一个 CPU 使用率 100% 的场景：
stress --cpu 1 --timeout 600
mpstat -P ALL 5 //-P ALL 表示监控所有 CPU
pidstat -u  5
```
### 发现专栏精选留言
>在 sched/loadavg.c 中计算平均值的算法为EMA，这种算法的目的主要是“距离目标预测窗口越近，则数据的价值越高，对未来影响越大”，如果说“更快的计算”应该只有里面的 fixed_power_int 函数用 O(log n) 的时间来算 x^n，所以内核中用 EMA 来算 loadavg 本质上并不是增加计算性能，而是让 loadavg 的趋势化更明显"

思考：看了下股票里MACD也有用到这个，以前在监控里对一些对时效敏感的时序数据可以用ema来设定阈值，不过得考虑异常情况的噪点去除

>我一直用htop看负载，因为它更直接（在F2配置中勾选所有开关项，打开颜色区分功能），不同的负载会用不同的颜色标识。比如cpu密集型的应用，它的负载颜色是绿色偏高，iowait的操作，它的负载颜色是红色偏高等等，根据这些指标再用htop的sort就很容易定位到有问题的进程。还有个更好用的atop命令，好像是基于sar的统计生成的报告，直接就把有问题的进程标红了，更直观

思考：htop,atop好用的工具mark
